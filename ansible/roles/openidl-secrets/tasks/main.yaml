---
- name: Update kubeconfig and set context to openidl {{ app_cluster_name }}
  shell: |
    export AWS_PROFILE=cicd-role; aws eks update-kubeconfig --region {{ aws_region }} --name {{ app_cluster_name }}

- name: Delete folder for HELM chart
  file:
   path: /tmp/openidl-code/helm
   state: absent

- name: Download HELM chart
  no_log: false
  shell: |
    git clone https://{{ gitrepo_name }} -b {{ gitrepo_branch }} /tmp/openidl-code/helm

- name: Copy config files
  copy:
   remote_src: true
   src: /tmp/openidl-code/{{ env_id }}-config/
   dest: /tmp/openidl-code/helm/openidl-k8s/charts/openidl-secrets/{{ org_name }}-{{ env }}-config/

- name: Create Kubernetes namespace {{ namespace }}
  k8s:
    name: "{{ namespace }}"
    kind: Namespace
    state: present
    wait: true
    wait_sleep: 2
    wait_timeout: 60

- name: Deploy secrets
  shell: |
    cd /tmp/openidl-code/helm/
    helm upgrade --install \
              {{ env }}-{{ org_name }}-secrets openidl-k8s \
              -f openidl-k8s/global-values-secrets.yaml -n {{ namespace }} \
            --set global.configpath={{ org_name }}-{{ env }}-config
  register: deploy_secrets

#- name: Dispose of temporary git repository content
#  file:
#   path: /tmp/openidl-code/
#   state: absent
