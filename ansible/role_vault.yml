---
- name: testing stuff
  hosts: all
  vars_files:
    - vars.yml
  vars:
    state: present
    wait_timeout: 3600
  tasks:
    - name: "Get KMS ID"
      shell: |
        export AWS_PROFILE=baf-role
        aws kms describe-key --key-id alias/{{ vault.network.org_name }}-{{ vault.env }}-vault-kmskey | jq -r .KeyMetadata.KeyId
      register: output

    - no_log: false
      set_fact:
        config_user: "{{ lookup('password', '/dev/null chars=ascii_lowercase,digits length=8') }}"

    - no_log: false
      set_fact:
        config_user_token: "{{ lookup('password', '/dev/null chars=ascii_uppercase,ascii_lowercase,digits length=40') }}"

    - no_log: false
      set_fact:
        kvs_user: "{{ lookup('password', '/dev/null chars=ascii_lowercase,digits length=8') }}"

    - no_log: false
      set_fact:
        kvs_user_token: "{{ lookup('password', '/dev/null chars=ascii_uppercase,ascii_lowercase,digits length=40') }}"

    - include_role:
        name: "vault"
      vars:
        vault_kms_key_id: "{{ output.stdout }}"
        vault_config_user: "config-{{ vault.network.org_name }}-{{ config_user }}"
        vault_config_user_token: "{{ config_user_token }}"
        vault_kvs_user: "kvs-{{ vault.network.org_name }}-{{ config_user }}"
        vault_kvs_user_token: "{{ kvs_user_token }}"